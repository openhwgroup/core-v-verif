<?xml version="1.0" ?>
<!-- Copyright 2023 Dolphin Design -->
<!-- SPDX-License-Identifier: Apache-2.0 WITH SHL-2.1 -->

{% import 'regress_macros.j2' as regress_macros -%}


<rmdb>

    <runnable name="{{project}}" type="group" sequential="yes">
        <parameters>
            <parameter name="results_sim_path">{{results_path}}/{{simulator}}_results</parameter>
        </parameters>
        <members>
{% for r in regressions %}
            <member>{{r.name}}</member>
{% endfor %}
            <member>report</member>
        </members>
    </runnable>


{% for r in regressions %}
    <runnable name="{{r.name}}" type="group" sequential="yes">
        <members>
{% for build in r.get_builds() %}
            <member>{{build.name}}</member>
{% endfor %}
        </members>
        <preScript launch="exec">
{% for b in r.get_builds_with_no_tests() %}
            <command> cd {{b.abs_dir}} &amp;&amp; {{b.cmd}} CV_CORE={{project}} CFG={{b.cfg}} CV_SIM_PREFIX= {{toolchain|upper}}=1 SIMULATOR={{b.simulator}} COV={{regress_macros.yesorno(b.cov)}} {{regress_macros.cv_results(results)}} {{makeargs}} </command>
{% endfor %}
        </preScript>
    </runnable>


{% for build in r.get_builds() %}
        <runnable name="{{build.name}}" type="group" sequential="no">
            <parameters>
                <parameter name="build_config">{{build.cfg}}</parameter>
                <parameter name="build_name">{{build.name}}</parameter>
            </parameters>
            <members>
{% for t in r.get_tests_of_build(build.name) %}
{% if t.precmd is defined %}
                <member>{{t.name}}_precmd</member>
{% else %}
                <member>{{t.name}}</member>
{% endif %}
{% endfor %}
            </members>
            <preScript launch="exec">
                <command> cd {{build.abs_dir}} &amp;&amp; {{build.cmd}} CV_CORE={{project}} CFG={{build.cfg}} CV_SIM_PREFIX= {{toolchain|upper}}=1 SIMULATOR={{build.simulator}} USE_ISS={{regress_macros.yesorno(build.iss)}} COV={{regress_macros.yesorno(build.cov)}} {{regress_macros.cv_results(results)}} {{makeargs}} </command>
            </preScript>
        </runnable>

{% endfor %}


{% for k,t in unique_tests.items() %}
{% if t.precmd is defined %}
            <runnable name="{{t.name}}_precmd" type="group" sequential="no">
                <parameters>
{% if t.cfg is defined %}
                    <parameter name="tst_cfg" >{{t.cfg}}</parameter>
{% else %}
                    <parameter name="tst_cfg" >(%build_config%)</parameter>
{% endif %}
                </parameters>
{% if lsf != None %}
                <method name="grid" gridtype="lsf" action="preScript">
                    <command> {{lsf}} -P {{project}} -J (%RUNNABLE%) (%WRAPPER%) </command>
                </method>
{% endif %}
                <members>
                    <member>{{t.name}}</member>
                </members>
                <preScript launch="exec" usestderr="no">
                    <command>cd {{t.abs_dir}} &amp;&amp; {{t.precmd}} COMP=0 CV_SIM_PREFIX= CV_CORE={{project}} COV=0 SIMULATOR={{t.simulator}} CFG=(%tst_cfg%) RISCVDV_CFG={{t.riscvdv_cfg}} GEN_START_INDEX=1 GEN_NUM_TESTS={{t.num}} USE_ISS=NO SEED=random</command>
                </preScript>
            </runnable>
{% endif %}

                <runnable name="{{t.name}}" type="task" sequential="no" repeat="{{t.num}}">
                    <parameters>
{% if t.precmd is not defined %}
{% if t.cfg is defined %}
                        <parameter name="tst_cfg" >{{t.cfg}}</parameter>
{% else %}
                        <parameter name="tst_cfg" >(%build_config%)</parameter>
{% endif %}
{% endif %}
{% if coverage != false %}
                        <parameter name="ucdbfile" >{{t.abs_dir}}/{{simulator}}_results/(%tst_cfg%)/{{t.testname}}/(%ITERATION%)/{{t.testname}}.ucdb</parameter>
{% endif %}
{% if t.precmd is not defined %}
                        <parameter name="log_file" >(%DATADIR%)/{{project}}/{{r.name}}/(%build_name%)/(%INSTANCE%)/execScript.log</parameter>
{% else %}
                        <parameter name="log_file" >(%DATADIR%)/{{project}}/{{r.name}}/(%build_name%)/{{t.testname}}_precmd/(%INSTANCE%)/execScript.log</parameter>
{% endif %}
                    </parameters>
{% if lsf != None %}
                    <method name="grid" gridtype="lsf" action="execScript">
                        <command> {{lsf}} -P {{project}} -J (%RUNNABLE%) (%WRAPPER%) </command>
                    </method>
{% endif %}
                    <execScript launch="exec" usestderr="no">
                        <command> cd {{t.abs_dir}} &amp;&amp; {{t.cmd}} CHECK_SIM_RESULT={{regress_macros.yesorno(check_sim_results)}} COMP=0 CV_SIM_PREFIX= CV_CORE={{project}} {{toolchain|upper}}=1 CFG=(%build_config%) RISCVDV_CFG={{t.riscvdv_cfg}} SIMULATOR={{t.simulator}} USE_ISS={{regress_macros.yesorno(t.iss)}} COV={{regress_macros.yesorno(t.cov)}} RUN_INDEX=(%ITERATION%) GEN_START_INDEX=(%ITERATION%) SEED=random {{regress_macros.cv_results(results)}} {{makeargs}} {{t.makearg}}</command>
                    </execScript>
                </runnable>


{% endfor %}



{% endfor %}

    <!-- =========== Reporting =========== -->
    <runnable name="report" type="group">
        <parameters>
            <parameter name="merged_file">(%results_sim_path%)/merged/merged.ucdb</parameter>
            <!-- <parameter name="tplan_file">(%results_sim_path%)/merged.ucdb</parameter> -->
        </parameters>
{% if coverage != false %}
        <preScript launch="exec">
            <command> cd {{results_path}} &amp;&amp; make cov_merge SIMULATOR={{simulator}}</command>
        </preScript>
{% endif %}
        <members>
            <member>html_report</member>
        </members>
        <postScript mintimeout="3000">
            <command>vrun -vrmdata (%DATADIR%) -status -full -html -htmldir (%DATADIR%)/vrun</command>
        </postScript>
    </runnable>

        <runnable name="html_report" type="task">
            <execScript>
                <command> if {[file exists (%merged_file%)]} {vcover report -annotate -testdetails -details -html (%merged_file%) -output [file join {{results_path}} cov_html_summary]} </command>
                <!-- <command> if {[file exists (%merged_file%)]} {vcover report -plansection=/. -html (%mergefile%) -output [file join (%results_sim_path%) cov_html_summary_testplan]} </command> -->
            </execScript>
        </runnable>

</rmdb>
